<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Conversation Viewer</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #b8b8b8;
            --accent: #e94560;
            --human-bg: #2d4059;
            --assistant-bg: #1a1a2e;
            --border-color: #3a3a5c;
            --branch-indicator: #ffc107;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            min-width: 300px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            color: var(--accent);
        }

        .file-input-wrapper {
            margin-top: 15px;
        }

        .file-input-wrapper input {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 10px 15px;
            background-color: var(--bg-tertiary);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input-label:hover {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .conversation-item:hover {
            border-color: var(--accent);
        }

        .conversation-item.active {
            border-color: var(--accent);
            background-color: rgba(233, 69, 96, 0.1);
        }

        .conversation-item h3 {
            font-size: 0.95rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item .meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-header {
            padding: 20px 30px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .conversation-header h2 {
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .conversation-header .meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }

        .message {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .message-header {
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message.human .message-header {
            background-color: var(--human-bg);
            color: #7fb3d5;
        }

        .message.assistant .message-header {
            background-color: var(--bg-tertiary);
            color: var(--accent);
        }

        .message-content {
            padding: 15px 20px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
        }

        .message.human .message-content {
            background-color: rgba(45, 64, 89, 0.3);
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content pre {
            background-color: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border-color);
        }

        .message-content code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 25px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content h1, .message-content h2, .message-content h3,
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 16px 0 10px 0;
            color: var(--text-primary);
        }

        .message-content h2 {
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .message-content h3 {
            font-size: 1.1rem;
        }

        .message-content blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 15px;
            margin: 12px 0;
            color: var(--text-secondary);
        }

        .message-content a {
            color: #7fb3d5;
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        /* Branch indicator */
        .branch-container {
            margin: 15px 0;
            padding: 15px;
            background-color: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--branch-indicator);
            border-radius: 8px;
        }

        .branch-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--branch-indicator);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .branch-label svg {
            width: 16px;
            height: 16px;
        }

        .branch-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .branch-btn {
            padding: 8px 16px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .branch-btn:hover {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .branch-btn.active {
            background-color: var(--branch-indicator);
            border-color: var(--branch-indicator);
            color: #000;
        }

        /* Tool use display */
        .tool-use {
            background-color: rgba(15, 52, 96, 0.5);
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .tool-use-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #7fb3d5;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .tool-use-message {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                min-width: 100%;
                height: auto;
                max-height: 40vh;
            }

            .messages-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Claude Conversations</h1>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" multiple accept=".json" />
                    <label for="fileInput" class="file-input-label">
                        Drop JSON files or click to browse
                    </label>
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversations will be listed here -->
            </div>
        </aside>

        <main class="main-content">
            <div class="empty-state" id="emptyState">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <h3>No Conversation Selected</h3>
                <p>Load JSON files and select a conversation to view</p>
            </div>
            <div id="conversationView" style="display: none;">
                <header class="conversation-header">
                    <h2 id="conversationTitle">Conversation Title</h2>
                    <div class="meta" id="conversationMeta"></div>
                </header>
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // Store loaded conversations
        const conversations = new Map();
        let activeConversationId = null;
        let selectedBranches = new Map(); // Track selected branch at each branch point

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const conversationList = document.getElementById('conversationList');
        const emptyState = document.getElementById('emptyState');
        const conversationView = document.getElementById('conversationView');
        const conversationTitle = document.getElementById('conversationTitle');
        const conversationMeta = document.getElementById('conversationMeta');
        const messagesContainer = document.getElementById('messagesContainer');

        // File input handler
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop support
        const fileInputLabel = document.querySelector('.file-input-label');
        fileInputLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInputLabel.style.backgroundColor = 'var(--accent)';
        });
        fileInputLabel.addEventListener('dragleave', () => {
            fileInputLabel.style.backgroundColor = '';
        });
        fileInputLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputLabel.style.backgroundColor = '';
            const files = e.dataTransfer.files;
            processFiles(files);
        });

        function handleFileSelect(event) {
            const files = event.target.files;
            processFiles(files);
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                if (file.name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.chat_messages) {
                                conversations.set(data.uuid, data);
                                updateConversationList();
                            }
                        } catch (err) {
                            console.error('Error parsing JSON:', err);
                        }
                    };
                    reader.readAsText(file);
                }
            });
        }

        function updateConversationList() {
            conversationList.innerHTML = '';

            // Sort by updated_at descending
            const sorted = Array.from(conversations.values()).sort((a, b) => {
                return new Date(b.updated_at) - new Date(a.updated_at);
            });

            sorted.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item' + (conv.uuid === activeConversationId ? ' active' : '');
                item.innerHTML = `
                    <h3>${escapeHtml(conv.name || 'Untitled')}</h3>
                    <div class="meta">${formatDate(conv.created_at)} &bull; ${conv.chat_messages.length} messages</div>
                `;
                item.addEventListener('click', () => selectConversation(conv.uuid));
                conversationList.appendChild(item);
            });
        }

        function selectConversation(uuid) {
            activeConversationId = uuid;
            selectedBranches.clear();
            updateConversationList();
            renderConversation();
        }

        function renderConversation() {
            const conv = conversations.get(activeConversationId);
            if (!conv) return;

            emptyState.style.display = 'none';
            conversationView.style.display = 'flex';
            conversationView.style.flexDirection = 'column';
            conversationView.style.flex = '1';
            conversationView.style.overflow = 'hidden';

            conversationTitle.textContent = conv.name || 'Untitled Conversation';
            conversationMeta.textContent = `Created: ${formatDate(conv.created_at)} | Model: ${conv.model || 'Unknown'}`;

            // Build message tree
            const messageTree = buildMessageTree(conv.chat_messages);

            // Render messages following the selected path
            messagesContainer.innerHTML = '';
            renderMessagePath(messageTree, conv.current_leaf_message_uuid);
        }

        function buildMessageTree(messages) {
            const tree = {
                messages: new Map(),
                children: new Map(), // parent_uuid -> [child_uuids]
                roots: []
            };

            const ROOT_PARENT = '00000000-0000-4000-8000-000000000000';

            messages.forEach(msg => {
                tree.messages.set(msg.uuid, msg);

                const parentUuid = msg.parent_message_uuid;

                if (!parentUuid || parentUuid === ROOT_PARENT) {
                    // This is a root message
                    tree.roots.push(msg.uuid);
                } else {
                    // Add to parent's children
                    if (!tree.children.has(parentUuid)) {
                        tree.children.set(parentUuid, []);
                    }
                    tree.children.get(parentUuid).push(msg.uuid);
                }
            });

            // If no parent_message_uuid fields exist, use index-based ordering
            if (tree.roots.length === 0 || (tree.roots.length === messages.length && messages.length > 1)) {
                tree.roots = [];
                tree.children.clear();

                const sorted = [...messages].sort((a, b) => a.index - b.index);
                sorted.forEach((msg, i) => {
                    if (i === 0) {
                        tree.roots.push(msg.uuid);
                    } else {
                        const prevUuid = sorted[i - 1].uuid;
                        if (!tree.children.has(prevUuid)) {
                            tree.children.set(prevUuid, []);
                        }
                        tree.children.get(prevUuid).push(msg.uuid);
                    }
                });
            }

            return tree;
        }

        function renderMessagePath(tree, currentLeafUuid) {
            // Start from the first root
            if (tree.roots.length === 0) return;

            let currentUuid = tree.roots[0];

            while (currentUuid) {
                const message = tree.messages.get(currentUuid);
                if (!message) break;

                // Render this message
                renderMessage(message);

                // Check for branches (multiple children)
                const children = tree.children.get(currentUuid) || [];

                if (children.length === 0) {
                    // End of branch
                    break;
                } else if (children.length === 1) {
                    // Single path, continue
                    currentUuid = children[0];
                } else {
                    // Branch point - show branch selector
                    renderBranchSelector(currentUuid, children, tree);

                    // Follow selected branch or default to first child
                    const selectedChild = selectedBranches.get(currentUuid) || children[0];
                    currentUuid = selectedChild;
                }
            }
        }

        function renderMessage(message) {
            const div = document.createElement('div');
            div.className = `message ${message.sender}`;
            div.dataset.uuid = message.uuid;

            const headerText = message.sender === 'human' ? 'You' : 'Claude';

            let contentHtml = '';
            if (message.content && message.content.length > 0) {
                message.content.forEach(item => {
                    if (item.type === 'text' && item.text) {
                        contentHtml += renderMarkdown(item.text);
                    } else if (item.type === 'tool_use') {
                        contentHtml += renderToolUse(item);
                    } else if (item.type === 'tool_result' && item.display_content) {
                        contentHtml += renderToolResult(item);
                    }
                });
            } else if (message.text) {
                contentHtml = renderMarkdown(message.text);
            }

            div.innerHTML = `
                <div class="message-header">${headerText}</div>
                <div class="message-content">${contentHtml || '<em>No content</em>'}</div>
            `;

            messagesContainer.appendChild(div);
        }

        function renderToolUse(item) {
            return `
                <div class="tool-use">
                    <div class="tool-use-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Tool: ${escapeHtml(item.name || 'Unknown')}
                    </div>
                    ${item.message ? `<div class="tool-use-message">${escapeHtml(item.message)}</div>` : ''}
                </div>
            `;
        }

        function renderToolResult(item) {
            if (item.display_content && item.display_content.type === 'rich_link') {
                const link = item.display_content.link;
                return `
                    <div class="tool-use">
                        <div class="tool-use-header">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                            <a href="${escapeHtml(link.url)}" target="_blank">${escapeHtml(link.title || link.url)}</a>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function renderBranchSelector(parentUuid, childUuids, tree) {
            const div = document.createElement('div');
            div.className = 'branch-container';

            const selectedChild = selectedBranches.get(parentUuid) || childUuids[0];

            let buttonsHtml = '';
            childUuids.forEach((childUuid, index) => {
                const child = tree.messages.get(childUuid);
                const isActive = childUuid === selectedChild;
                const preview = getMessagePreview(child);
                buttonsHtml += `
                    <button class="branch-btn ${isActive ? 'active' : ''}"
                            data-parent="${parentUuid}"
                            data-child="${childUuid}">
                        Branch ${index + 1}: ${preview}
                    </button>
                `;
            });

            div.innerHTML = `
                <div class="branch-label">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    Conversation Branch Point
                </div>
                <div class="branch-buttons">${buttonsHtml}</div>
            `;

            // Add click handlers
            div.querySelectorAll('.branch-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const parent = btn.dataset.parent;
                    const child = btn.dataset.child;
                    selectedBranches.set(parent, child);
                    renderConversation();
                });
            });

            messagesContainer.appendChild(div);
        }

        function getMessagePreview(message) {
            if (!message) return '...';

            let text = '';
            if (message.content && message.content.length > 0) {
                for (const item of message.content) {
                    if (item.type === 'text' && item.text) {
                        text = item.text;
                        break;
                    }
                }
            }

            if (!text && message.text) {
                text = message.text;
            }

            text = text.replace(/[#*_`\[\]]/g, '').trim();
            return text.length > 30 ? text.substring(0, 30) + '...' : text || '...';
        }

        function renderMarkdown(text) {
            if (!text) return '';

            let html = escapeHtml(text);

            // Code blocks (```)
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang}">${code.trim()}</code></pre>`;
            });

            // Inline code (`)
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Italic
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Unordered lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Numbered lists
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

            // Blockquotes
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

            // Paragraphs (double newlines)
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<pre>)/g, '$1');
            html = html.replace(/(<\/pre>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            html = html.replace(/<p>(<blockquote>)/g, '$1');
            html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');

            // Single line breaks
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return dateString;
            }
        }

        // Auto-load JSON files from the same directory (for local file:// access)
        // This won't work due to CORS, so users need to use the file picker
        console.log('Claude Conversation Viewer loaded. Please select JSON files to view.');
    </script>
</body>
</html>
